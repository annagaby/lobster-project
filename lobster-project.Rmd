---
title: "lobster-project"
author: "Anna Calle"
date: "11/12/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE}
# Load packages and read .csv files
#install.packages("vcdExtra")
library(tidyverse)
library(vcdExtra)
library(car)
library(onewaytests)
library(kableExtra)

size_abundance <- read_csv("lobster_size_abundance.csv")
traps <- read_csv("lobster_traps.csv")

#You will be describing lobster size, abundance and fishing pressure at five Long-Term Ecological Research (LTER) Sites in the Santa Barbara Channel close to the mainland: Arroyo Quemado (AQUE), Naples Reef (NAPL), Mohawk Reef (MOHK), Isla Vista (IVEE), Carpinteria (CARP).
```

### 1. Lobster abundance and fishing pressure (2012 - 2017)
Describe trends in lobster abundance (counts) and fishing pressure (trap buoys) at the five locations from 2012 - 2017. Ignore transect information - we are only interested in evaluating abundance and pressure on the
order of SITE. Note: you are not expected to use regression here - just think of ways to clearly describe annual totals visually and in text, noting important trends, events and differences.

```{r}
# Transform data into case form

size_abundance <- data.frame(size_abundance)
size_abun_case <- expand.dft(size_abundance, freq = "COUNT")

#create table and graph of lobster abundance by site and year

abundance_table <- size_abun_case %>% 
  count(YEAR, SITE) %>% 
  spread(SITE, n)

#summarized abundances 
abundance_summary <- size_abundance %>% 
  group_by(SITE, YEAR) %>% 
  summarize(abundance = sum(COUNT))

abundance_summary

#Figure of abundances
abundance_figure <- ggplot(abundance_summary, aes(x = YEAR, y = abundance)) +
  geom_line(aes(color = SITE)) +
  theme_classic()+
  theme(axis.text.x=element_text(angle=90,hjust=1))+
  labs(y = "Abundance of Lobsters", x= "Year") +
  #geom_errorbar(aes(ymin=,ymax=), width=.2) +
  theme(axis.text=element_text(size=11))+
  theme(axis.title=element_text(size=12))+
  scale_y_continuous(expand = c(0,0), limits = c(0,750))+
  scale_x_continuous(expand = c(0,0), limits = c(2012,2017))

abundance_table 

final_table_lobsters <- kable(abundance_table, col.names = c("Year", "Arroyo Quemado", "Carpinteria", "Isla Vista", "Mohawk Reef", "Naples Reef"), align = "c") %>% 
   kable_styling(bootstrap_options = "striped", full_width = F) %>% 
  kable_styling(bootstrap_options = "hover") %>% 
  column_spec(1, bold = T) %>% 
  row_spec(0, bold = T, color = "black")

final_table_lobsters #finalized table


  
```



```{r}
#create table and graph of trap buoy counts by site and year 

traps <- data.frame(traps)

traps_case <- traps %>%   
  filter(SITE != "ABUR", SITE != "AHND", SITE != "AHND to AQUE", SITE != "GOLB") %>% 
  group_by(SITE, YEAR) %>% 
  summarize(trap_count = sum(TRAPS))

traps_table <-traps_case %>% # Kirby there are no columns for Isla Vista or Naples reef because the trap counts were 0 in the original traps datset. Need to add column in table/add data into graphs 
  
  spread(SITE, n)

traps_table

final_traps_table <- kable(traps_table, col.names = c("Year", "Arroyo Quemado", "Carpinteria", "Mohawk Reef"), align = "c") %>% 
   kable_styling(bootstrap_options = "striped", full_width = F) %>% 
  kable_styling(bootstrap_options = "hover") %>% 
  column_spec(1, bold = T) %>% 
  row_spec(0, bold = T, color = "black")

final_traps_table
```

### 2. Compare mean lobster size by site in 2017
Compare mean lobster sizes (carapace length (mm)) across the five sites for lobster observations collected in 2017. Warning: the size data are not in tidy format. There are rows that contain size information for multiple
lobsters observed (e.g., if the researcher saw 3 lobsters all with carapace length ~ 60 mm, then they will have a single row where COUNT = 3 and SIZE = 60). You’ll want to get this into case format - where each lobster has its own row - before doing statistical analyses. There are many ways to do this. One hint: function expand.dft in the vcdExtra package (it doesn’t like tibbles, so you might need to coerce to data.frame first).
```{r}
# Compare mean lobster sizes across sites 

#Create dataframe with only 2017 observations to run ANOVA

mean_sizes <- size_abun_case %>% 
  filter(YEAR == 2017) 

#Use Levene's test for equal variances 

#H0: Variances are equal
#HA: Variances are not equal 

lobster_variance <- leveneTest(SIZE ~ SITE, data = mean_sizes)

lobster_variance

#Kruskal- Wallis test for non-parametic data, because variances are not equal

#H0: There is no significant difference in mean lobster sizes across different sites
#HA: At least two sites have signficantly different means


lobster_aov <- aov(SIZE ~SITE, data = mean_sizes, variance = FALSE)
summary(lobster_aov)


# Kruskal-Wallis reveals that there are at least two means that are significantly different, therefore, we should run Tukey's HSD to explore further (post hoc test)

lobster_ph <- TukeyHSD(lobster_aov)

lobster_ph


# Mean lobster sizes differ significantly between Naples Reef (NAPL) and Carpinteria (CARP) (p = 0.023), Naples Reef (NAPL) and Isla Vista (IVEE) (0.004), Naples Reef (NAPL) and Mohawk Reef (MOHK) (p = 0.057).    


```


### 3. Changes in lobster size at MPA and non-MPA sites (comparing only 2012 and 2017 sizes)
At Isla Vista and Naples Reef, the two protected MPA sites (with zero fishing pressure), how do lobster sizes in 2012 and 2017 compare? At the non-MPA sites?
```{r}
#two years (2012 and 2017)
#two managment levels 

```


### 4. Proportions of “legal” lobsters at the 5 sites in 2017
The legal minimum carapace size for lobster is 82.6 mm. What proportion of observed lobsters at each site are above the legal minimum? Does that proportion differ significantly across the 5 sites? 

```{r}
minimum_carapace <- mean_sizes %>% 
  mutate( 
    carapace = case_when(
      SIZE > 82.6 ~ "Above",
      SIZE < 82.6 ~ "Below"
    )
    ) %>% 
  count(SITE, carapace) %>% 
  spread(carapace, n) %>% 
  select(-SITE)

rownames(minimum_carapace) <- c("AQUE", "CARP","IVEE","MOHK","NAPL")
minimum_carapace


```
```{r}
# Actual proportions:

carapace_prop <- prop.table(as.matrix(minimum_carapace), 1)
carapace_prop

# Chi-square test for independence
carapace_x2 <- chisq.test(minimum_carapace)
carapace_x2
```


