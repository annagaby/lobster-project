---
title: "lobster-project"
author: "Anna Calle"
date: "11/12/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE}
# Load packages and read .csv files
#install.packages("vcdExtra")
library(tidyverse)
library(vcdExtra)
library(car)
library(onewaytests)
library(kableExtra)

size_abundance <- read_csv("lobster_size_abundance.csv")
traps <- read_csv("lobster_traps.csv")

#You will be describing lobster size, abundance and fishing pressure at five Long-Term Ecological Research (LTER) Sites in the Santa Barbara Channel close to the mainland: Arroyo Quemado (AQUE), Naples Reef (NAPL), Mohawk Reef (MOHK), Isla Vista (IVEE), Carpinteria (CARP).
```

### 1. Lobster abundance and fishing pressure (2012 - 2017)
Describe trends in lobster abundance (counts) and fishing pressure (trap buoys) at the five locations from 2012 - 2017. Ignore transect information - we are only interested in evaluating abundance and pressure on the
order of SITE. Note: you are not expected to use regression here - just think of ways to clearly describe annual totals visually and in text, noting important trends, events and differences.

```{r}
# Transform data into case form

size_abundance <- data.frame(size_abundance)
size_abun_case <- expand.dft(size_abundance, freq = "COUNT")

#create table and graph of lobster abundance by site and year

abundance_table <- size_abun_case %>% 
  count(YEAR, SITE) %>% 
  spread(SITE, n)

#summarized abundances 
abundance_summary <- size_abundance %>% 
  group_by(SITE, YEAR) %>% 
  summarize(abundance = sum(COUNT),
            sd = sd(COUNT))

abundance_summary

#Figure of abundances
abundance_figure <- ggplot(abundance_summary, aes(x = YEAR, y = abundance)) +
  geom_line(aes(color = SITE)) +
  theme_classic()+
  theme(axis.text.x=element_text(angle=90,hjust=1))+
  labs(y = "Abundance of Lobsters", x= "Year") +
  #geom_errorbar(aes(ymin=,ymax=), width=.2) +
  theme(axis.text=element_text(size=11))+
  theme(axis.title=element_text(size=12))+
  scale_y_continuous(expand = c(0,0), limits = c(0,750))+
  scale_x_continuous(expand = c(0,0), limits = c(2012,2017))


final_table_lobsters <- kable(abundance_table, col.names = c("Year", "Arroyo Quemado", "Carpinteria", "Isla Vista", "Mohawk Reef", "Naples Reef"), align = "c") %>% 
   kable_styling(bootstrap_options = "striped", full_width = F) %>% 
  kable_styling(bootstrap_options = "hover") %>% 
  column_spec(1, bold = T) %>% 
  row_spec(0, bold = T, color = "black")

final_table_lobsters #finalized table


  
```



```{r}
#create table and graph of trap buoy counts by site and year 

traps <- data.frame(traps)

traps_case <- traps %>%   
  filter(SITE != "ABUR", SITE != "AHND", SITE != "AHND to AQUE", SITE != "GOLB") %>% 
  group_by(SITE, YEAR) %>% 
  summarize(trap_count = sum(TRAPS))

#figure of graph 

traps_figure <- ggplot(traps_case, aes(x = YEAR, y = trap_count)) +
  geom_line(aes(color = SITE)) +
  theme_classic() +
  theme(axis.text.x=element_text(angle=90,hjust=1)) +
  labs(y = "Trap Count", x= "Year") +
   theme(axis.text=element_text(size=11))+
  theme(axis.title=element_text(size=12))+
  scale_y_continuous(expand = c(0,0), limits = c(0,1200))+
  scale_x_continuous(expand = c(0,0), limits = c(2012,2017))

traps_figure

```

### 2. Compare mean lobster size by site in 2017
Compare mean lobster sizes (carapace length (mm)) across the five sites for lobster observations collected in 2017. Warning: the size data are not in tidy format. There are rows that contain size information for multiple
lobsters observed (e.g., if the researcher saw 3 lobsters all with carapace length ~ 60 mm, then they will have a single row where COUNT = 3 and SIZE = 60). You’ll want to get this into case format - where each lobster has its own row - before doing statistical analyses. There are many ways to do this. One hint: function expand.dft in the vcdExtra package (it doesn’t like tibbles, so you might need to coerce to data.frame first).
```{r}
# Compare mean lobster sizes across sites 

#Create dataframe with only 2017 observations to run ANOVA

mean_sizes <- size_abun_case %>% 
  filter(YEAR == 2017) 

#Use Levene's test for equal variances 

#H0: Variances are equal
#HA: Variances are not equal 

lobster_variance <- leveneTest(SIZE ~ SITE, data = mean_sizes)

lobster_variance

#Kruskal- Wallis test for non-parametic data, because variances are not equal

#H0: There is no significant difference in mean lobster sizes across different sites
#HA: At least two sites have signficantly different means


lobster_aov <- aov(SIZE ~SITE, data = mean_sizes)
summary(lobster_aov)


# Kruskal-Wallis reveals that there are at least two means that are significantly different, therefore, we should run Tukey's HSD to explore further (post hoc test)

lobster_ph <- TukeyHSD(lobster_aov)

lobster_ph


# Mean lobster sizes differ significantly between Naples Reef (NAPL) and Carpinteria (CARP) (p = 0.023), Naples Reef (NAPL) and Isla Vista (IVEE) (0.004), Naples Reef (NAPL) and Mohawk Reef (MOHK) (p = 0.057).    


```


### 3. Changes in lobster size at MPA and non-MPA sites (comparing only 2012 and 2017 sizes)
At Isla Vista and Naples Reef, the two protected MPA sites (with zero fishing pressure), how do lobster sizes in 2012 and 2017 compare? At the non-MPA sites?
```{r}

#two years (2012 and 2017)
#two managment levels 

#5 separate t-tests (unpaired) between 2012 and 2017 at each site. No t tests between sites. That will be in our analysis 


#First look at the three non MPA sites######################

#Site 1: AQUE (Arroyo Quemado)

AQUE_2017 <- size_abun_case %>% 
  filter(YEAR == 2017, SITE == "AQUE")

AQUE_2012 <- size_abun_case %>% 
  filter(YEAR == 2012, SITE == "AQUE")

#ftest to compare variances at AQUE in 2012 and 2017 
# null: Variances are equal (ratio is equal to 1)
# alternative: Variances are not equal (ratio is not equal to 1)

AQUE_ftest <- var.test(AQUE_2012$SIZE, AQUE_2017$SIZE)

AQUE_ftest

#ftest indicates that variances are equal (p =0.29). Use students t-test to compare sizes at AQUE in 2012 and 2017

AQUE_ttest <- t.test(AQUE_2012$SIZE, AQUE_2017$SIZE, var.equal = TRUE)
  
AQUE_ttest

#####Our two sample t-test indicates that there is no significant difference in lobster size at Arroyo Quemado (p=0.209) in 2012 (mean = 71) and 2017 (mean = 73.89) ##################


#Site 2: MOHK (Mohawk Reef)

MOHK_2017 <- size_abun_case %>% 
  filter(YEAR == 2017, SITE == "MOHK")

MOHK_2012 <- size_abun_case %>% 
  filter(YEAR == 2012, SITE == "MOHK")

#ftest to compare variances in lobster size at NAPL in 2012 and 2017 
# null: Variances are equal (ratio is equal to 1)
# alternative: Variances are not equal (ratio is not equal to 1)

MOHK_ftest <- var.test(MOHK_2012$SIZE, MOHK_2017$SIZE)

MOHK_ftest

#ftest indicates that variances are equal (p =0.15). Use students t-test to compare sizes at NAPL in 2012 and 2017

MOHK_ttest <- t.test(MOHK_2012$SIZE, MOHK_2017$SIZE, var.equal = TRUE)
  
MOHK_ttest

#################Our two sample t-test indicates that there is a significant difference in lobster size at Mohwak Reef (p=0.000067) in 2012 (mean = 77) and 2017 (mean = 72) #####################

#Site 3: CARP (Carpinteria)

CARP_2017 <- size_abun_case %>% 
  filter(YEAR == 2017, SITE == "CARP")

CARP_2012 <- size_abun_case %>% 
  filter(YEAR == 2012, SITE == "CARP")

#ftest to compare variances in lobster size at NAPL in 2012 and 2017 
# null: Variances are equal (ratio is equal to 1)
# alternative: Variances are not equal (ratio is not equal to 1)

CARP_ftest <- var.test(CARP_2012$SIZE, CARP_2017$SIZE)

CARP_ftest

#ftest indicates that variances are equal (p =0.204). Use students t-test to compare sizes at NAPL in 2012 and 2017

CARP_ttest <- t.test(CARP_2012$SIZE, CARP_2017$SIZE, var.equal = TRUE)
  
CARP_ttest

####################Our two sample t-test indicates that there is no significant difference in lobster size at Isla Vista (p=0.182) in 2012 (mean = 74.35) and 2017 (mean = 72.29) ############

# MPA sites######################

#Site 4: Isla Vista (IVEE) 

IVEE_2017 <- size_abun_case %>% 
  filter(YEAR == 2017, SITE == "IVEE")

IVEE_2012 <- size_abun_case %>% 
  filter(YEAR == 2012, SITE == "IVEE")

#ftest to compare variances in lobster size at NAPL in 2012 and 2017 
# null: Variances are equal (ratio is equal to 1)
# alternative: Variances are not equal (ratio is not equal to 1)

IVEE_ftest <- var.test(IVEE_2012$SIZE, IVEE_2017$SIZE)

IVEE_ftest

#ftest indicates that variances are equal (p =0.307). Use students t-test to compare sizes at NAPL in 2012 and 2017

IVEE_ttest <- t.test(IVEE_2012$SIZE, IVEE_2017$SIZE, var.equal = TRUE)
  
IVEE_ttest

#Our two sample t-test indicates that there is no significant difference in lobster size at Isla Vista (p=0.059) in 2012 (mean = 66.07) and 2017 (mean = 71.4) 

#Site 5: Naples Reef (NAPL) 

NAPL_2017 <- size_abun_case %>% 
  filter(YEAR == 2017, SITE == "NAPL")

NAPL_2012 <- size_abun_case %>% 
  filter(YEAR == 2012, SITE == "NAPL")

#ftest to compare variances in lobster size at NAPL in 2012 and 2017 
# null: Variances are equal (ratio is equal to 1)
# alternative: Variances are not equal (ratio is not equal to 1)

NAPL_ftest <- var.test(NAPL_2012$SIZE, NAPL_2017$SIZE)

NAPL_ftest

#ftest indicates that variances are equal (p =0.76). Use students t-test to compare sizes at NAPL in 2012 and 2017

NAPL_ttest <- t.test(NAPL_2012$SIZE, NAPL_2017$SIZE, var.equal = TRUE)
  
NAPL_ttest

#Our two sample t-test indicates that there is no significant difference in lobster size at Naples Reef (p=0.5002) in 2012 (mean = 73) and 2017 (mean = 76.23) 




# The only location that differed signficantly in lobster size from 2012-2017 was Mohawk (p= 0.000067). Every other location had no significant difference in lobster sies from 2012-2017

```


### 4. Proportions of “legal” lobsters at the 5 sites in 2017
The legal minimum carapace size for lobster is 82.6 mm. What proportion of observed lobsters at each site are above the legal minimum? Does that proportion differ significantly across the 5 sites? 

```{r}
minimum_carapace <- mean_sizes %>% 
  mutate( 
    carapace = case_when(
      SIZE > 82.6 ~ "Above",
      SIZE < 82.6 ~ "Below"
    )
    ) %>% 
  count(SITE, carapace) %>% 
  spread(carapace, n) %>% 
  select(-SITE)

rownames(minimum_carapace) <- c("AQUE", "CARP","IVEE","MOHK","NAPL")
minimum_carapace


```
```{r}
# Actual proportions:

carapace_prop <- prop.table(as.matrix(minimum_carapace), 1)
carapace_prop

# Chi-square test for independence
carapace_x2 <- chisq.test(minimum_carapace)
carapace_x2
```


